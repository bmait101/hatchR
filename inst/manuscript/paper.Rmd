---
title: ""
output: pdf_document
header-includes:
   - \usepackage{lineno}
   - \linenumbers
bibliography: ms_refs.bib
csl: apa.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## hatchR: A toolset to predict when fish hatch and emerge

Morgan M. Sparks^1,4^, Eli A. Felts^2^, Allison G. Swartz^3^, Bryan M. Maitland^1^

^1^Rocky Mountain Research Station, U.S. Forest Service, Boise, ID, USA

^2^Idaho Fish and Wildlife Conservation Office, U.S. Fish and Wildlife Service, Orofino, ID, USA

^3^College of Forestry, Oregon State University, Corvallis, OR, USA

^4^Corresponding Author: Morgan M. Sparks, Morgan.Sparks\@usda.gov

keywords: developmental phenology, effective value model, R, Shiny

\newpage

# Abstract

Understanding the timing of key life history events is essential for effective fish conservation and management. Traditionally, predicting hatch and emergence timing in wild fish populations was challenging due to the reliance on average incubation temperature as a primary model parameter, which is often difficult in to obtain in natural settings. Recent advancements have refined these models, enabling their application in wild environments using spawning dates and daily water temperature records. However, their broader use remains constrained by a lack of parameterizations for many species, with most applications focused on salmonids. Here we introduce **hatchR**, a software ecosystem designed to predict hatch and emergence for a wide range of wild fishes. **hatchR** offers users access to established phenological models and the flexibility to incorporate custom parameterizations using external datasets. The software is available in two formats: an open-source R package for advanced customization and an HTML-based graphical user interface for those unfamiliar with scripting. To illustrate its utility, we present two case studies demonstrating its application in research and management. By expanding assess to predictive modeling tools, **hatchR** has the potential to advance studies of fish early life history and support conservation efforts across diverse species.

\newpage

# Introduction

As poikilothermic organisms, fish development and growth are closely tied to ambient environment. This strong relationship has enabled researchers to generate statistical models that predict developmental phenology with high accuracy. Historically, these models were formulated in aquaculture settings under the assumption of constant temperature throughout development [@beacham1990; @mcphail1979; @alderdice1978], limiting their applicability to wild populations. However, @sparks2019 reformulated this approach into an "Effective Value model", which instead uses daily average temperature after spawning, predicting hatch or emergence when cumulative effective values reach a threshold of one.

This effective value approach has since been widely applied to salmonids, for which aquaculture-derived parameterizations were readily available. For example, Pacific Salmon (*Oncorhynchus* spp.) models developed by @beacham1990 have been applied across various species and populations [@adelfio2024; @adelfio2019; @kaylor2021], while Bull Trout (*Salvelinus confluentus*) models from @mcphail1979 were extended by @austin2019. Despite its growing adoption, applications of the effective value model remian largely confined to salmonids, likelu due to the availability of existing parameterizations and the commercial and recreational importance of these species.

To extrend these modeling capabilities beyond salminds and facilitate broader applications, we developed **hatchR**, a software ecosystem designed to predict hatch and emergence timing for wild fish populations. **hatchR** enables users to input standard raw or summarized water temperature datasets commonly collected in field settings, conduct basic data validation, and apply built-in parameterizations such as those from @beacham1990 or @sparks2017. Users can also develop custom models using their own or published temperature and phenological data within the effective value framework.

To maximize accessibility, **hatchR** is available in two formats. The first is a R package, **hatchR**, distributed via CRAN (REF), providing advanced customization and automation for analyzing mutiple variables, such as phenology type, spawn timing, or thermal regimes. Comprehensize documentation is available on the **hatchR** website (<https://bmait101.github.io/hatchR/>). The second is a Shiny-based web application (@chang2024), offering a graphical user interface for those unfamiliar with R, balancing ease of use with much of the R package's core functionality. Below, we provide and overview of **hatchR** and present case studies demonstrating its application in research and management.

```{r echo=FALSE, message=FALSE}
### 
library(tidyverse); library(hatchR); library(ggdist); library(ggridges)
```

# Package Overview

**hatchR** is designed primarily as a tool for predicting fish phenology. To maintain focus on this core function, we provide minimal build-in data validation and vizualization tools, as users are expected to understand and check their own data. Given the diversity of potential data types, it is impractical to implement comprehensize validation checks. However, we include basic data-checking functions (`check_continuous()`, `summarize_temp()`) and limited built-in visualization capabilities (`plot_check_temp()`, `plot_phenology()`). Intuitive functions are provided for users to apply models (either existing models from the literature using the `model_select()` function or fitting custom functions from data using the `fit_model()` function). Users can then apply these models to water temperature data (e.g. from a HOBO temp logger) to predict when hatching phenology will occur. This is accomplished with the `predict_phenology()` function. The R package provides example workflows for customizing plots from model output, while the Shiny application includes a default output plot and an option to download results for external vizualizations. For a high-level overview of **hatchR**'s applications, see Figure 1. Additional details on key functions and workflows–particulalry for automating phenology predictions across multiple variables–are available in articles hosted on the software's webpage.

```{r, echo = FALSE, out.height = '75%', fig.align = 'center', fig.cap="hatchR workflow. Data inputs are represented by folders, data processes by filled circles, hatchR functions as plain text rectangles, and decisions choices as italicized text."}
knitr::include_graphics("./workflow.png")
```

## Effective value models

Effective value models were introduced by @sparks2019 to predict developmental timing in wild populations, initially for Sockeye Salmon (*O. nerka*). Their development was necessitated by limitations in traditional models, such as those in @beacham1990, which relied on average incubation temperature over the full developmental period. In wild settings, estimating this average temperature was impracticable since hatch timing was unknown, even when spawning dates were recorded. To overcome this challenge, @sparks2019 reformulated model 2 from @beacham1990 by taking its reciprocal and assigning an *effective value* to each day of development based on the daily average temperature. This approach allowed for cumulative tracking of developmental progress, enabling hatch and emergence predictions without requiring prior knowledge of incubation temperatures.

The model follows the general format of:

$$
\mathrm{E_i} = \frac{1}{\exp(\log_e(a) - \log_e(T_i - b)}
$$

where $E_i$ is the effective value and $T_i$ the temperature for day $i$, and $a$ and $b$ are model parameterization estimates (i.e. species- or model-specific constants).

This framework as the foundation for phenological models in **hatchR**. The package includes a predefined `model_table` containing established parameterizations, including those from @beacham1990, @sparks2017, and @austin2019 (who extended @mcphail1979). While `model_table` incorporated more complex models from @beacham1990, users can also fit custom models using the `fit_model()` function. This flexibility allows for the incorporation of new parameterizations as they are developed, expanding the utility of **hatchR** beyond salmonids.

## Data format

Water temperature datasets collected in the field typically fall into two categories: 1) summarized daily data, where mean daily temperatures are pre-computed, or 2) raw high-frequency data, such as those recorded by HOBO TidbiT loggers, which require summary into mean daily temperatures before use. Additionally, new statistical models, such as @siegel2023, could also be implemented into this framework.

**hatchR** assumes input data consists if at least two required columns: a date column indicating the date (and optionally time) of each temperature measurement, and a temperature column providing the corresponding temperature measurement (in °C). Other columns may be present, but columns names should not include spaces. Data should follow the format outlined in Table 1.

```{r kabletable, echo=FALSE }
df = data.frame(date = c("2000-01-01",
                         "...",
                         "2000-07-01",
                         "...",
                         "2000-12-31"),
                temperature= c(2.51,
                        "...",
                        16.32,
                        "...",
                        3.13
                        ))

# kable can alse be used for creating tables
knitr::kable(df,
             booktabs=TRUE,
             caption = "Example temperature data for use in hatchR.")
```

Since **hatchR** does not automatically handle missing data, users must check for gaps or errors before running analyses. The package will function with missing values, but gaps in the dataset may affect predictions. **hatchR** supports temperatures as low as 0 °C, though such values yield extremely small effective values, potentially extending hatch or emergence timing to a year or more. Users should critically assess whether such data align with biological expectations.

For R users, **hatchR** can import data in any format, provided it is converted into a `data.frame` or `tibble`, where each row represents a single temperature record. The Shiny application requires data to be uploaded as a .csv (comma separated values) file, which can easily be exported from spreadsheet software such as Microsoft Excel or Google Sheets.

## Checking Data

**hatchR** is designed to analyze daily average temperatures. While high-frequency data (e.g., from HOBO loggers) can be used, it must be summarized into daily averages. **hatchR** provides built-in functionality for this summarization in R but requires pre-summarized data for use in the Shiny app. 

To help users identify potential issues, **hatchR** includes basic data checking functions that highlight outliers or missing values both visually and programatically. These checks ensure data integroty before model application.  

We demonstrate the utility three functions: `summarize_temp()`, `plot_check_temp()`, and `check_continuous()`--using a simulated year-long data set (`year_sim`). This dataset contains temperature readings taken every thirty minutes, and its structure (dimentions and first six rows) is shown below.

```{r, echo = FALSE}
library(lubridate)
# create date object for a year with 30 min reading intervals
dates <- seq(from = ymd_hms("2000-07-01 00:00:00"),
             to = ymd_hms("2001-06-30 23:59:59"), length.out = 17568) 

# create empty dataframe
year_sim <- data.frame(matrix(NA, nrow = length(dates), ncol = 1)) 

# date column
colnames(year_sim)[1] <- "date" 

# add dates vector to date column
year_sim[1] <- dates 

#random seed
set.seed(123)

# take temps from a random normal dist with mean 10 sd 3 
# for every date time combo in dates and append to column (temp) 
# in year_sim
year_sim$temp <- rnorm(n = length(dates), mean = 10, sd = 3) %>%
  abs() 

```

```{r}
#year_sim data dimensions
dim(year_sim)
#fist 6 rows of year_sim
head(year_sim)
```

First, we recommend using `plot_check_temp()` to visually inspect imported data for outliers or unusual values (Figure 2).

```{r, echo = TRUE, fig.cap="Output of hatchR function `plot_check_temp()`, which is used as a visual data check on the raw `year_sim` data set. Users can set custom thresholds for minimum and maximum temperatures (dashed lines)."}
plot_check_temp(data = year_sim,
                dates = date,
                temperature = temp,
                temp_min = 0, # temp_min and max lines are 
                              # user customizable
                temp_max = 25)
```

In this case, no obvious outliers are present, but since each day contains 48 records, the data must be summarized to daily mean temperature using `summarize_temp()`. After summarization, `check_continuous()` should be used to identify any missing days. We also suggest running `plot_check_temp()` again on the summarized data to verify its integrity, though we omit the resulting plot here for space efficiency.

```{r, echo = TRUE}
# summarize
year_sim_summ <- summarize_temp(data = year_sim,
                                dates = date,
                                temperature = temp)

# now a year's worth of single-day data
dim(year_sim_summ)

# check continuous (no errors)
check_continuous(data = year_sim_summ,
                 dates = date)

# we can demonstrate an error by removing Oct. 8 (100th day)
check_continuous(data = year_sim_summ[-100,],
                 dates = date)


```

## Model Selection

Users can select from existing Salmonid models in `model_table` or generate custom models using `fit_model()` in both the R and Shiny deployments of **hatchR**. The models in `model_table` are included because their parameterizations are well-documented in the literature, though they are currently limited to Pacific Salmon and Bull Trout (see @quinn2018 pg. 183, for additional Salmonid models). To ensure reliability, we restrict `model_table` to well vetted models with experimental ranges spanning 2-17 °C. 

Custom models, by contrast, often have narrower parameterization ranges. To prevent misapplication, we exclude other model parameterization from `model_table`, requiring users to carefully asses whether their parameterized models are appropriate for the temperature ranges in their datasets.

To expand the applicability of the effective value approach beyond Salmonids, **hacthR** includes a `fit_model()` function, which is species-agnostic as long as development follows a power law relationship with temperature. The function takes two input vectors--one for average incubation temperature (°C) and one for the number of days to a given phenological event--and estimates model parameters (*log~e~a* and *b*) using `stats::nls()`. 

This approach allows users to generate models tailored to non-Salmonid species, provided they have experimental or field data linking development to temperature. However, users should be mindful that custom models may not generalize well beyond the temperature range of the data used to fit the model. Future expansions of **hatchR** could incorporate additional vetted parameterizations for other taxa, pending sufficient validation in the literature. 

### Fitting models for other fishes

We demonstrate how the `fit_model()` function may be used to create custom parameterizations for species beyond the Salmonids included in `model_table`. To showcase its utility, we provide parameterizations for  three warm-water species: Smallmouth Bass (*Micropterus dolomieu*) [@webster1948], Channel Catfish (*Ictalurus punctatus*) [@small2001], and Lake Sturgeon (*Acipenser fulvescens*) [@smith2005]. These species were selected due to their common use in aquaculture and sport fisheries, illustrating the broad applicability of the effective values approach. For conciseness, we present parameterization for Smallmouth Bass here, while the full implementation details for all species are available in the [paper.Rmd](https://github.com/bmait101/hatchR/blob/master/inst/manuscript/paper_pdf/paper.Rmd) on the  GitHub project repository.

Next, we generate a simulated thermal regime featuring an ascending thermograph with a mean temperature of 16 °C. Using this dataset, we apply the parameterized models for each species to predict hatch timing and total developmental duration (Figure 3). This example highlights the flexibility of **hatchR** im accommodating diverse fish species and environmental conditions, making it a valuable tool for researchers and managers working outside of Salmonid system. 

```{r, echo=FALSE}
library(dplyr)
###  make temp regime
set.seed(123)
# create random temps and corresponding dates
temps_sim <- sort(rnorm(n =30, mean = 16, sd = 1), decreasing = FALSE)
dates_sim <-  seq(from = ymd("2000-07-01"),
             to = ymd("2000-07-31"), length.out = 30)

data_sim <- matrix(NA, 30, 2) |> data.frame()
data_sim[,1] <- temps_sim
data_sim[,2] <- dates_sim

# change names so they aren't the same as the vector objects
colnames(data_sim) <- c("temp_sim", "date_sim")
```

```{r, echo = TRUE}

### smallmouth mod
smallmouth <- matrix(NA, 10, 2) |> data.frame()
colnames(smallmouth) <- c("hours", "temp_F")
smallmouth$hours <- c(52, 54, 70, 78, 90, 98, 150, 167, 238, 234)
smallmouth$temp_F <- c(77, 75, 71, 70, 67, 65, 60, 59, 55, 55)

# change °F to °C and hours to days
smallmouth <- smallmouth |> 
  mutate(days = ceiling(hours/24),
         temp_C = (temp_F -32) * (5/9))

# model object for smallmouth bass 
smb_mod <- fit_model(temp = smallmouth$temp_C,
                     days = smallmouth$days,
                     species = "smb",
                     development_type = "hatch")


```

```{r, echo=FALSE}

### catfish mod
catfish <- matrix(NA, 3, 2) |> data.frame()
colnames(catfish) <- c("days", "temp_C")
catfish$days <- c(16,21,26)
catfish$temp_C <- c(22,10,7)

cat_mod <- fit_model(temp = catfish$temp_C,
                     days = catfish$days,
                     species = "catfish",
                     development_type = "hatch")

### lake sturgeon mod
sturgeon <-  matrix(NA, 7, 2) |> data.frame()
colnames(sturgeon) <- c("days", "CTU")
sturgeon$days <- c(7,5,6,6,5,11,7)
sturgeon$CTU <- c(58.1, 62.2, 61.1, 57.5, 58.1, 71.4, 54.7)

sturgeon <- sturgeon |> 
  mutate(temp_C = CTU/days) # change CTUs to average temp and add column

sturgeon_mod <- fit_model(days = sturgeon$days,
                          temp = sturgeon$temp_C,
                          species = "sturgeon",
                          development_type = "hatch")



```

Note the *R^2^* fit from the models below. You can see they generally preform well and are in line with values from model 2 of @beacham1990.

```{r, echo = TRUE}
#model fits
smb_mod$r_squared; cat_mod$r_squared; sturgeon_mod$r_squared
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Predicted days to hatch for three warmwater species with custom parameterizations using a random thermal regime with an ascending thermograph with a mean temperature of 16 °C over 30 days."}
### predict_phenology

#smallmouth bass
smb_res <- predict_phenology(data = data_sim,
                  dates = date_sim,
                  temperature = temp_sim,
                  spawn.date = "2000-07-01",
                  model = smb_mod$expression)

# catfish
catfish_res <- predict_phenology(data = data_sim,
                  dates = date_sim,
                  temperature = temp_sim,
                  spawn.date = "2000-07-01",
                  model = cat_mod$expression)

# sturgeon
# note that 16 C is pretty far out of range of temps for model fit, not best practice
sturgeon_res <- predict_phenology(data = data_sim,
                  dates = date_sim,
                  temperature = temp_sim,
                  spawn.date = "2000-07-01",
                  model = sturgeon_mod$expression)

# summary for all species
all_res <- data.frame(matrix(NA, 3, 2))
colnames(all_res) <- c("start", "stop")

all_res$start <- c(catfish_res$dev.period$start, 
                   smb_res$dev.period$start, 
                   sturgeon_res$dev.period$start)

all_res$stop <- c(catfish_res$dev.period$stop,
                  smb_res$dev.period$stop, 
                  sturgeon_res$dev.period$stop)


all_res <- all_res |> 
  mutate(days = ceiling(stop-start),
         index = c(17,16.5,16))

all_res$Species <- c("Channel Catfish", "Smallmouth Bass", "Lake Sturgeon")


ggplot() +
  geom_point(data = data_sim, aes(x = date_sim, y = temp_sim )) + 
  geom_line(data = data_sim, aes(x = date_sim, y = temp_sim )) +
  geom_rect(data = all_res, aes(xmin = start, xmax = stop, ymax =index-.35, ymin = index-.5, fill = Species)) +
  geom_label(data = all_res, aes(x = start + (stop - start) / 1.25, y = (index -0.425), label = days)) +
  labs(x = "Date", y = "Temperature (°C)") +
  scale_fill_manual(values = c("deepskyblue4", "grey23", "darkolivegreen4")) +
  theme_classic() +
  theme(legend.position = c(0.75, 0.25))
```

## Predicting Phenology and Output

To illustrate model selection and phenology prediction we will recreate a small portion of the analysis done by @sparks2019 using the `woody_island` data set included in this package. We will predict both hatch and emergence timing, so we will obtain a model expression for each using `model_select()`, which calls built-in models from `model_table`.

```{r, echo = TRUE}
sockeye_hatch_mod <- model_select(
  author = "Beacham and Murray 1990", 
  species = "sockeye", 
  model = 2, 
  development_type = "hatch"
  )
```

We can now use our model expressions to predict when sockeye would hatch and emerge at Woody Island in 1990. First we predict hatch timing using `predict_phenology()`:

```{r, warning=FALSE, echo = TRUE}
WI_hatch <- predict_phenology(
  data = woody_island,
  dates = date,
  temperature = temp_c,
  spawn.date = "1990-08-18",
  model = sockeye_hatch_mod
  )
```

And then look at the returned object to see days to hatch and development period:

```{r, echo = TRUE}
WI_hatch$days_to_develop
WI_hatch$dev.period
```

### Understanding your results

The output from `predict_phenology()` includes a lot of information. If we look at our `WI_hatch` object we see there are multiple elements stored in a list which can be accessed using the `$` operator.

```{r, eval=FALSE, echo = TRUE}
str(WI_hatch)
```

`WI_hatch$days_to_develop` outputs the predicted days to develop.

`WI_hatch$dev.period` is a 1x2 dataframe with the dates corresponding to when your fish's parent spawned (which you input with `predict_phenology(spawn.date = ...)`) and the date when the fish is predicted to develop.

`WI_hatch$ef_table` is a *n* x 5 tibble (*n* = number of days to hatch or emerge) and the columns are a row index, the date, each day's temperature and effective value, and the cumulative sum of the effective values. The `ef_table` object is meant to serve as the basis for users to make custom figures for their data beyond the functionality we discuss below.

`WI_hatch$model_specs` provides details about the model used for predicting phenology, which varies depending on if the model was generated from `model_select()` or `fit_model()`, but most importantly contains the model expression (*e.g.*, the formula) used for prediction.

### Plotting phenology

**hatchR** has a built in function, `plot_phenology()`, that allows users to visualize their phenology results (Figure 4). The plot visualizes three specific components: 1.) the temperature regime over which you are predicting, 2.) the cumulative sum of effective values, and 3.) the effective value for each day in your prediction span. The function allows you to output various figures based on your interests, but defaults to a figure with all information and the corresponding labels.

```{r, fig.cap="Output of `plot_phenolgy()` function using predicted hatch time from `woody_island` data set."}
plot_phenology(WI_hatch)
```

# Case Study 1

A common management scenario where developmental phenology might be useful would be trying to understand if fish might be free-moving before some management action. For instance, will fish have emerged from redds when a stream section has been opened to grazing or road work?

In this scenario, we will consider the road work example and Bull Trout, a threatened fish in the United States under the Endangered Species Act [@nolfi2024], and the Crooked River, a key Bull Trout population in the Boise River watershed. In this hypothetical scenario, the Forest Fisheries Biologist wants to know if fish will likely be out of the gravel and free-swimming by June 1st as Bull Trout are particularly sensitive to sediment. In this system, it is expected that Bull Trout will be done spawning by the end of September, so we'll consider the last possible spawn date as September 30th.

We demonstrate this first case study using the graphical user interface portion of the **hatchR** ecosystem found at [https://elifelts.shinyapps.io/hatchR_demo/](https://elifelts.shinyapps.io/hatchR/){.uri}. Users will first upload their data with the `Import Data` window, which requires them to select their file on their personal computer, provide the program with the columns corresponding for dates and temperatures, and then provide the format in which dates are coded (*e.g.*, year-month-day or day-month-year). Data used in this case study are from the `crooked_river` data set. It is included as a demo data set in Shiny, but can also be written out from the package or accessed at <https://github.com/bmait101/hatchR/blob/master/extdata/crooked_river.csv/>. Once data is uploaded the program automatically plots the user's data using `plot_check_temp()` in the background and provides them the outputted graphical check. After uploading and checking data, the user switches to the `Model Phenology` window. In this circumstance, we use the preloaded parameterization for bull trout from @austin2019 with the `Existing` button for model selection, which the user selects with the various drop down options in the menu. After the model is selected, the user can choose multiple spawn dates from the interactive calendar provided. We show results for spawning for September 30th as indicated in the example above. Once dates are chosen, a table entry for each spawn date is outputted in the `Phenology Summaries` tab and corresponding plot with data from each spawn date in the `Timeline Plot` tab. Output from predicting phenology and the resulting figure are downloadable from their respective tabs. The process is demonstrated in the included ***supplementary video file???***, but the interface is described more completely on **hatchR**'s Shiny website.

```{r, eval=FALSE, echo=FALSE}

### read in EFS data

EFS_data <- crooked_river

### view bull trout models and select model

model_table |> 
  filter(species == "bull trout")

# we care about when fish are out of gravel, so select emerge mod
bt_emerge_mod <- model_select(author = "Austin et al. 2017",
                            species = "bull trout",
                            model = "MM",
                            development_type = "emerge")

# predict emergence time using Sept. 30 as the spawn date 
bt_emergence <- predict_phenology(data = EFS_data,
                                  dates = date,
                                  temperature = temp_c,
                                  spawn.date = "2011-09-30", 
                                  model = bt_emerge_mod)

# fish emerge May 1, before June 1
bt_emergence$dev.period$stop


```

In this example we expect the last fish out of the gravel well before the June 1st date and the manager could allow road work in this area without worrying about sediment disturbance to fish developing in the gravel.

# Case Study 2

For the second example, we will again use Bull Trout, but demonstrate a much more complex application for the purpose of showing the full flexibility of the programmatic application of **hatchR**. In this scenario we will use data from @isaak2018 (included `idaho` data set), which includes temperature data from 226 sites across the major upper Columbia River headwater watersheds in Idaho. For this approach we winnow putative bull trout spawning sites by filtering for sites with mean August temperature \</= 13 °C in accordance with thresholds from @isaak2015. For the resulting 139 sites we will demonstrate predicting hatch timing in these putative Bull Trout spawning habitats.

```{r, echo = FALSE}

bull_trout_sites <- idaho |> 
  mutate(month = month(date)) |> #make a month column (numeric)
  filter(month == 8) |> # filter out Aug.
  group_by(site) |> # apply grouping by site
  summarise(mean_aug_temp = mean(temp_c)) |> 
  filter(mean_aug_temp <= 13) |> # keep only sites 13 C or cooler
  pull(site) |> 
  unique()

# filter to bull trout sites
idaho_bt <- idaho |> 
  filter(site %in% bull_trout_sites) 

# nest data and summarize
isaak_summ_bt <- idaho_bt |> 
  group_by(site) |> 
  nest() |> 
  mutate(
    summ_obj = map(
      data, 
      summarize_temp,
      temperature = temp_c,
      dates = date
      )
    ) |> 
  select(site, summ_obj) 

# spawn dates
spawn_dates <- map(
  c(2011:2014), # year vector to map for custom function
  function(year) { # custom paste function
    c(
      paste0(year, "-09-01"),
      paste0(year, "-09-15"),
      paste0(year, "-09-30")
      )
    }
  ) |> 
  unlist()

# bull trout hatch model
bt_hatch <- model_select(
  development_type = "hatch",
  author = "Austin et al. 2019",
  species = "bull trout",
  model = "MM"
)
```

We need to setup our models and data for this analysis, which we don't demonstrate here for the sake of concision, however they are demonstrated in `paper.Rmd` included in the GitHub repository for **hatchR**. After the setup, we can easily map `predict_phenology()` across all putative spawning sites and three spawn dates (September 1-Early Spawning, September 15-Peak Spawning, and September 31-Late Spawning), the results of which are presented in Figure 5.

```{r, echo = TRUE}
hatch_res <- isaak_summ_bt |> 
  mutate(
    dev_period = map2(
      summ_obj, spawn_dates, # map across our site object and spawn dates
      predict_phenology,
      temperature = daily_temp,
      model = bt_hatch,
      dates = date
      ) |> 
      map_df("dev.period") |> # pull out just dev.period results
      list()
    ) |> 
  select(site, dev_period) |> # just select the columns we want
  unnest(cols = c(dev_period)) |> # unnest everything
  mutate(days_to_hatch = stop - start) # make a new column of days to hatch
```

```{r, message=FALSE, echo=FALSE,  out.width='75%', fig.align='center', fig.cap="Predicted days to hatch for 139 putative bull trout populations over three spawning periods (Early = September 1, Peak = September 15, Late = September 30) and four years of temperature data."}
cut_ints <- date(
  c(
    "2011-08-31", "2012-08-31",
    "2013-08-31", "2014-08-31",
    "2015-08-31"
  )
)

# add year and spawn time factors for plotting
hatch_factors <- hatch_res |> 
  mutate(year = cut(start,
    breaks = cut_ints,
    labels = c(2011:2014)
  )) |>
   # cut coerces our labels to factors, this changes them back to numbers
  mutate(year = as.numeric(as.character(year))) |> 
  mutate(day = day(start)) |> 
  mutate(spawn_time = case_when(
    day == 1 ~ "Early",
    day == 15 ~ "Peak",
    day == 30 ~ "Late"
  )) |>
  mutate(spawn_time = factor(
    spawn_time, levels = c("Late", "Peak", "Early"), 
    ordered = TRUE)
    ) 

hatch_factors_sum <- hatch_factors |> 
  group_by(year, spawn_time, start) |> 
  summarise(mean_hatch = ceiling(mean(days_to_hatch)),
            hatch_5 = ceiling(quantile(days_to_hatch, probs = 0.05)),
            hatch_95 = ceiling(quantile(days_to_hatch, probs = 0.95)))


ggplot(
  data =  hatch_factors,
    aes(
      x = days_to_hatch,
      y = spawn_time,
      fill = spawn_time,
      color = spawn_time
    )) +
  geom_density_ridges(alpha = 0.9) +
    facet_wrap( ~ year, ncol = 1) +
    scale_fill_brewer(palette = "Blues", direction = 1) +
    scale_color_brewer(palette = "Blues", direction = 1) +
    labs(x = "Days to hatch", y = "Spawn time") +
    theme_classic() +
    theme(legend.position = "none")
```

# Discussion

With **hatchR** we present a software ecosystem that bridges the analytical gap of predicting developmental phenology for wild fishes and develops a formal framework for applying effective value models from user-provided parameterizations. To do so, the software is bundled in two forms, a fully customizable R package, especially useful for running repetitive or complex analyses and a graphical-user-interface designed for ease of use and tasks that may only run once or a handful of times. Both applications allows users to import their data, run basic data checks, and apply historic model parameterizations for Salmonids or create their own species- or population specific parameterizations. Additionally, we provide substantial documentation on the **hatchR** website (<https://bmait101.github.io/hatchR/>) to walk users through basic to advanced applications of the two platforms.

In the application of using effective value models **hatchR** and the user make some key assumptions. Particularly, numerous studies have indicated that stressful environmental conditions can cue fish to prematurely hatch or emerge from their environment. These include water quality like dissolved oxygen, pH, or salinity, pathogens, and even mechanical agitation (reviewed in @quinn2018 and @cowan2024). Moreover, while the **hatchR** provides point estimates for developmental phenology, spawning and developmental within populations of fishes both occur as distributions as opposed single events @mason1976 and we encourage users to either predict phenology using early, peak, and late frameworks (*e.g.*, 5th, 50th, and 95th quantiles) or with real or modeled distributions. Another factor that could bias estimates from these models is that temperatures used from sensors do not reflect the geomorphic properties in the environment where eggs are developing such that they may be too cold or warm @geist2002.

To date, the application of the effective value framework has largely focused using species-specific models to predict phenology in wild environments (see @adelfio2024, @austin2019). However, we emphasize that the statistical relationships at the basis of these models are fundamentally reaction norms, meaning that both the intercept and slope of the responses of fishes to temperature are reflective of family- or population-level genetic variation, genetic x environment responses, or may be indicative of phylogenetic differences among species (@west-eberhard2003). For instance, while @sparks2017 did not find differences in the rates of development between the focal populations of their study, they did observe family-level genetic x environment interactions across different thermal regimes. Similarly, when they reparameterized their models using fish from western Alaska, they found differences in both the slope and intercept of the model relative to the original parameterization from @beacham1990, notably derived from multiple Canadian stocks. The western Alaskan fish generally developed more slowly than their southerly counterparts, consistent with cogradient variation (@conover2009, @sparks2022). In this sense, we encourage users not to only think about the end points of these models (days to development) but also how the statistical relationships they are premised on inform our understanding of micro- and and macro-evolutionary processes.

**BRYAN check the below**

The models presented in **hatchR** can be further customized in multiple ways beyond the use-cases provided above. For instance, while our models are fit to predict hatch or emergence timing, they could be used to predict other developmental stages prior to the initiation of external feeding like eye-up or other embryological developmental stages (@velsen1980) or ***Some example from a non-salmonid, maybe initiation of pelagic-larval or riverine current dispersal***. Additionally, while `fit_model()` relies on non-linear modeling platform, `predict_phenology()` only requires users to pass a model expression, so if users preferred a different model fit than the non-linear option provided (as long as it integrates daily temperature), they could pass a different expression into `predict_phenology()` for additional customization. Finally, while **hatchR** was designed specifically for fishes, we expect other poikilothermic organisms such as reptiles, amphibians, or invertebrates would develop in accordance with the power law and these developmental models could be extended to other organisms beyond fishes.

# Conclusion

**hatchR** bridges the analytical gap for the prediction of developmental phenology for fishes in wild environments. It provides basic data checks and summarization, options for existing or custom model parameterization, and simple to complex phenology prediction frameworks. Importantly, it extends the effective value framework developed by @sparks2019 to a generalizable tool that can be applied to any fish species or population as long as the appropriate source data are available, which can easily be collected in aquaculture settings. We present basic applications for how **hatchR** may be used, with additional and more detailed examples provided on the software's [website](https://bmait101.github.io/hatchR/). **hatchR** is designed for applied and basic applications in which users can engage with the resource in a programmatic environment or a point-and-click Shiny app. We expect we have only demonstrated a small suite of the applications **hatchR** may be used for and encourage the user community to creatively build on the framework developed here.

# Acknowledgements

We thank Laura Koller for her help designing the **hatchR** logo. Dan Isaak provided useful discussion about model development and temperature data sets.

The views expressed in this manuscript are those of the authors and do not necessarily represent the views or policies of USFS or USFWS. Any mention of trade names, products, or services does not imply an endorsement by the U.S. government, USFS, or USFWS. USFS and USFWS do not endorse any commercial products, services or enterprises.

# Conflicts of Interest

The authors declare no known conflicts of interest.

# Data Availability

**hathcR** is fully open source and reproducible. Source code and data can be found at <https://github.com/bmait101/hatchR/>. The latest version will be archived upon acceptance of the manuscript.

# Ethics Statement

All data was derived from pre-published sources or created synthetically.

# Funding

The authors declare no funding sources.

# References
