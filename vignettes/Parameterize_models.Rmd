---
title: "Parameterize hatchR Models"
author: "Morgan Sparks, Bryan M. Maitland"
bibliography: '`r system.file("references.bib", package="hatchR")`'
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Parameterize hatchR Models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
# rmd style
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  warning = FALSE, 
  message = FALSE, 
  fig.align = 'center',
  fig.width = 6
)

# load packages
library(hatchR)
library(tibble)
library(ggplot2)
```

## Overview

This vignette describes the process of parameterizing models for predicting fish phenology using **hatchR**. The package provides two options for choosing phenological models. One is to use model parameterizations installed the package and the other is to create your own using data you import. We will cover both options in this vignette. First, we load `hatchR`:

```{r, eval = FALSE}
library(hatchR)
```


## Built-in parameterizations

The simplest way to get started is to use built-in parameterizations, which are included in the `model_table`. This table includes parameterizations for several salmonid species relating temperature to hatch and emergence timing, and can be selected using `model_select()`.

Let get a sense of the table, which comes installed with `hatchR`:

```{r}
model_table
```

We see that `model_table` is a tbble with 51 rows and 5 columns:

* `author`: The author(s) and year of publication for the model
* `species`: The species the model is parameterized for
* `model`: The model number (specific to @beacham1990 who created several models)
* `dev.type`: The phenological development type (i.e., hatch or emerge)
* `func`: The model expression / parameterization

You will use `author`, `species`, `model`, and `dev.type` to select model functions.

For instance, if you wanted to access the parameterization for sockeye hatching using model #2 from @beacham1990 you would run:

```{r}
sockeye_hatch_mod <- model_select(
  author = "Beacham and Murray 1990", 
  species = "sockeye", 
  model = 2, 
  dev.type = "hatch"
  )

#print out the expression to check
sockeye_hatch_mod
```

Note, that the above arguments are equivalent to the first line and four columns from `model_table`. Your model function object---in this case `sockeye_hatch_mod`---can then be passed to `predict_phenology()`, which we will demonstrate in the **Predicting Phenology** vignettes.

To see all available characterizations use:

```{r, eval=FALSE}
View(model_table)
```

## Creating custom models

`hatchR` also includes functionality to generate your own custom model parameterizations for predicting hatching and emergence phenology. **Importantly**, the custom parameterization relies on the model format developed from ***model 2*** of @beacham1990, which we chose because of its overall simplicity and negligible loss of accuracy. See @beacham1990 and @sparks2019 for more specific discussion regarding model 2 and the development of the effective value approach.

The model follows the general format of:

$$
Effective Value_i = 1/exp(log_ea - log_e(Temperature_i - b))
$$

Where *i* is the daily value and a fish hatches or emerges when the cumulative sum or $$\sum_{i =1}^nEffectiveValue_i = 1$$

The function `fit_model()` uses data where average incubation temperature (°C) and days to phenological event are the inputs and parameterizes the above model for *log~e~a* and *b*. So, for example, to borrow data from Table 8.1 (pg. 183) from @quinn2018, we can generate a custom hatch parameterization for brown trout.

You could either create a .csv file with those data and import them with `readr::read_csv()` or alternatively, directly input them as an object in R. We'll use `tibble()` to create the data, which in installed with `hatchR` and loaded using:

```{r, eval=FALSE}
library(tibble)
```

We can now create the data object:

```{r}
# vector of temperatures
temperature <- c(2,5,8,11,14)

#vector of days to hatch
days_to_hatch <- c(194,87,54,35,28)

#make a tibble of the two vectors
quinn_bt_hatch <- tibble(temperature, days_to_hatch)
quinn_bt_hatch
```

We can plot our data for a sanity check using `ggplot2`. First load the package:

```{r, eval=FALSE}
library(ggplot2)
```

Now plot the data:

```{r}
ggplot(quinn_bt_hatch, aes(x = temperature, y = days_to_hatch)) +
  geom_point() +
  theme_classic()
```

We can now use `fit_model()` to create our custom parameterization from our data.

```{r}
# brown trout hatch mod
bt_hatch_mod <- fit_model(df = quinn_bt_hatch, 
                          temp = temperature, 
                          days = days_to_hatch)
```

The output of `fit_model()` is a list with numerous elements, including the full model, coefficients for *log~e~a* and *b*, the expression you will pass to `predict_phenology()`, a plot to see your fit for your data, and some diagnostic variables. You can see the full extent using

```{r, eval=FALSE}
bt_hatch_mod
```

We can inspect a plot of predicted versus observed data, which looks good. 

```{r}
bt_hatch_mod$pred_plot
```

The vast majority of the time, what you will want is the actual expression which you will pass to `predict_phenology()` in the `model = ...` argument of that function, which you can either pass directly with the `$` operator by calling `$mod` element of the list (e.g., `model = bt_hatch_mod$mod)`) or set as an object to pass. Like so

```{r}
# creae an object with the model expression to pass to predict_phenology()
bt_hatch_exp <- bt_hatch_mod$mod
```

### Important considerations for your custom models

***Your model fits will only be as good as the data they are generated from***. Here are some important considerations:

1.  We recommend a minimum of four temperature x hatch/emerge data points.

2.  Data should be spread across temperatures as much as possible.

    -   It's much better to have a fit derived from data for temperatures such as 3, 7, 10, 14 °C than it is 8, 9, 10, 11 °C.

    -   The behavior of the model function around the tails of very cold or warm temperatures (relative to the fish species) drive the fit of the function, so more extreme temperatures are helpful.

3.  Think hard about whether the data you are generating your parameterization from match the data from which you are trying to predict or if you are extrapolating beyond what is sensible for the model.

4.  Understand your response variable, most models are fit to 50% hatch or emergence for a family group or population. However, your data may be different and you should interpret your results accordingly (e.g. comparisons between 50% hatch from population A to 95% hatch of population B may not be reasonable).


# References {.unnumbered}

::: {#refs}
:::
:::::::
