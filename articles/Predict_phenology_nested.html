<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Predict fish phenology: nested • hatchR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Predict fish phenology: nested">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">hatchR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Introduction to hatchR</h6></li>
    <li><a class="dropdown-item" href="../articles/Introduction.html">Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/Parameterize_models.html">Parameterize hatchR Models</a></li>
    <li><a class="dropdown-item" href="../articles/Predict_phenology_basic.html">Predict fish phenology: basic</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Advanced hatchR</h6></li>
    <li><a class="dropdown-item" href="../articles/Predict_phenology_advanced.html">Predict fish phenology: advanced</a></li>
    <li><a class="dropdown-item" href="../articles/Predict_phenology_nested.html">Predict fish phenology: nested</a></li>
    <li><a class="dropdown-item" href="../articles/Advanced_plotting.html">Advanced plotting</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/bmait101/hatchR/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Predict fish phenology: nested</h1>
                        <h4 data-toc-skip class="author">Morgan Sparks,
Bryan M. Maitland</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/bmait101/hatchR/blob/master/vignettes/Predict_phenology_nested.Rmd" class="external-link"><code>vignettes/Predict_phenology_nested.Rmd</code></a></small>
      <div class="d-none name"><code>Predict_phenology_nested.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h3>
<p>The goal of this vignette is to provide some examples of how you
might access results from <code><a href="../reference/predict_phenology.html">predict_phenology()</a></code> and how you
might plot your data.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bmait101.github.io/hatchR/">hatchR</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/ggridges/" class="external-link">ggridges</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">isaak_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="st">"~/Library/CloudStorage/Box-Box/Morgan.Sparks/Projects/hatchR/data/Isaak_et_al_2018_long.csv"</span><span class="op">)</span></span>
<span><span class="va">isaak_dat</span> <span class="op">&lt;-</span> <span class="va">isaak_dat</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h3>
<p><strong>hatchR</strong> is designed to be flexible to achieve many
applications. However, by virtue of being built as a scripting
application, <strong>hatchR</strong> is able to tackle very large
datasets relatively quickly and efficiently. Below we demonstrate an
example of a nested dataset with multiple sites that include multiple
years of data.</p>
</div>
<div class="section level3">
<h3 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h3>
<div class="section level4">
<h4 id="initial-checks">Initial Checks<a class="anchor" aria-label="anchor" href="#initial-checks"></a>
</h4>
<p>These data are downloaded (and modified to long format) from <span class="citation">Isaak et al. (2018)</span> and generally cover the
Boise, Payette, Clearwater, and upper Salmon River watersheds.</p>
<!-- ![Figure 1 from Isaak et al. 2018.](images/Screenshot%202024-11-20%20at%209.46.14%20AM.png){width="331"} -->
<p>To get started lets take a quick look at the data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># it's quite a large dataset, about 826000 records</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">isaak_dat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#count number of unique sites</span></span>
<span><span class="va">isaak_dat</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">site</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># grab site column</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co">#pair down so we only have a single instance of each site name</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="op">)</span> <span class="co">#count the number of records of the unique site name vector</span></span></code></pre></div>
<p>You can see there are 226 sites with about 826,000 individual records
of water temperature.</p>
<p>For this application, we’ll be thinking about these sites at putative
bull trout spawning habitat. We know from <span class="citation">Isaak
et al. (2015)</span> that we generally stop observing bull trout where
mean August temperatures are above 13 °C. So, we’ll first filter sites
out for those cooler than 13 °C.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create a vector of site names with temps at or below 13 C</span></span>
<span><span class="va">bull_trout_sites</span> <span class="op">&lt;-</span> <span class="va">isaak_dat</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>month <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html" class="external-link">month</a></span><span class="op">(</span><span class="va">SampleDate</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co">#make a month column (numeric)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">month</span> <span class="op">==</span> <span class="fl">8</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># filter out Aug.</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">site</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># apply grouping by site</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>mean_aug_temp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">temperature</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">mean_aug_temp</span> <span class="op">&lt;=</span> <span class="fl">13</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># keep only sites 13 C or cooler</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">site</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># we now have a list of 139 sites</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">bull_trout_sites</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create a dataset filtered on our bull trout sites</span></span>
<span><span class="va">isaak_dat_bt</span> <span class="op">&lt;-</span> <span class="va">isaak_dat</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">site</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">bull_trout_sites</span><span class="op">)</span> <span class="co"># only keep sites in our vector of bull trout sites</span></span>
<span></span>
<span><span class="co">#still lots of data!</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">isaak_dat_bt</span><span class="op">)</span></span></code></pre></div>
<p>Next we’ll want to do some data checks to make sure everything looks
alright.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># lets look at a couple individual sites</span></span>
<span><span class="va">PIBO_1345</span> <span class="op">&lt;-</span> <span class="va">isaak_dat_bt</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">site</span> <span class="op">==</span> <span class="st">"PIBO_1345"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># looks nice</span></span>
<span><span class="fu"><a href="../reference/plot_check_temp.html">plot_check_temp</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">PIBO_1345</span>,</span>
<span>                        dates <span class="op">=</span> <span class="va">SampleDate</span>,</span>
<span>                        temperature <span class="op">=</span> <span class="va">temperature</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#looks like there are multiple records per day so we need to summarize those in the larger dataframe (isaak_dat_bt)</span></span>
<span><span class="va">PIBO_1345</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">SampleDate</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="nested-dataframes">Nested Dataframes<a class="anchor" aria-label="anchor" href="#nested-dataframes"></a>
</h4>
<p>The package <code>dplyr</code> allows us to use a neat functionality
called nested data. For our datatset, we can think of it in terms of a
dataframe made up of a bunch of smaller dataframes where the identifier
for separating the data is the name in the <code>site</code> column.
These sub dataframes then are the records for each site in our example
and we can separate them to programatically so that we can use the same
function across them without skipping into the next datafield. It
utilizes the same approach we applied with <code><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map()</a></code> but allows
us to separate the function across individual datasets stored in our
larger dataframe.</p>
<p>In this first example we want to summarize our data by day, which we
can do using the following code.</p>
<p>First let’s just look at what nesting does before we actually make an
object.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">isaak_dat_bt</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">site</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="co"># we group by site</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">nest</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># nest our grouped data</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The resulting data structure is tibble with a new data column called
data. The data column is actually a list and each row contains its own
individual tibble (dataframe).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">isaak_summ_bt</span> <span class="op">&lt;-</span> <span class="va">isaak_dat_bt</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">site</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># we group by site</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">nest</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># use dplyr to nest our data based on our grouping</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>summ_obj <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">data</span>, <span class="co"># we'll create a new list column called summ_obj</span></span>
<span>                            <span class="va">summarize_temp</span>,</span>
<span>                            temperature <span class="op">=</span> <span class="va">temperature</span>,</span>
<span>                            dates <span class="op">=</span> <span class="va">SampleDate</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># </span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">site</span>, <span class="va">summ_obj</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># look at first six rows of full object</span></span>
<span><span class="va">isaak_summ_bt</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># look at first six rows</span></span>
<span></span>
<span><span class="co">#pluck the first site to see its structure</span></span>
<span><span class="va">isaak_summ_bt</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html" class="external-link">pluck</a></span><span class="op">(</span><span class="st">"summ_obj"</span>, <span class="fl">1</span><span class="op">)</span> <span class="co"># pluck first tibble of summ_obj</span></span></code></pre></div>
<p>Since we’ll be operating on these as nests we will keep them as a
nest, however if you wanted to change back to the original dataframe
format it’s easy with <code><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest()</a></code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">isaak_summ_bt</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="va">summ_obj</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="data-check">Data Check<a class="anchor" aria-label="anchor" href="#data-check"></a>
</h4>
<p>We can do a last data check to make sure we have continuous data.</p>
<p>First we’ll use a smaller example to show how it works and then
expand to our full dataset.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#start on an idividual example</span></span>
<span></span>
<span><span class="va">PIBO_1345_summ</span> <span class="op">&lt;-</span> <span class="va">isaak_summ_bt</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">site</span> <span class="op">==</span> <span class="st">"PIBO_1345"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="st">"summ_obj"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># we create a column that eiter contains NA, TRUE, or FALSE</span></span>
<span><span class="co"># NA is for first data</span></span>
<span><span class="co"># TRUE is if the difference between one row and the row preceding it is 1</span></span>
<span><span class="co"># FALSE is the difference is not 1</span></span>
<span><span class="va">PIBO_1345_summ</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>diff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span><span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">diff</span> <span class="op">==</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="co"># since the output is empty there are no FALSE in diff</span></span>
<span></span>
<span><span class="co"># we can do the same to our isaak_summ_bt dataset</span></span>
<span><span class="co"># only difference here is we are mapping with an anonymoys function hence the</span></span>
<span><span class="co"># ~{..., .x$date...}</span></span>
<span><span class="co"># ~{} tells us it's an anonymous function while the .x allows to us to call the column from whatever data</span></span>
<span><span class="co"># is piped in</span></span>
<span></span>
<span><span class="va">isaak_summ_bt</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>diff <span class="op">=</span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">summ_obj</span>,<span class="op">~</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">.x</span><span class="op">$</span><span class="va">date</span><span class="op">)</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">}</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">summ_obj</span>, <span class="va">diff</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># unnest for our filter</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">diff</span> <span class="op">==</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="co"># all continuous!</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="mapping-across-nested-data">Mapping Across Nested Data<a class="anchor" aria-label="anchor" href="#mapping-across-nested-data"></a>
</h3>
<p>Now that we have our data in the format we want and we’re confident
that it doesn’t have any gaps we can start to map our
<strong>hatchR</strong> functions onto the data.</p>
<p>First we need to make a vector of spawn dates and get our model set
up.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># spawn datest</span></span>
<span><span class="va">spawn_dates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2011</span><span class="op">:</span><span class="fl">2014</span><span class="op">)</span>, <span class="co"># year vector to map for custom function </span></span>
<span>                                  <span class="kw">function</span><span class="op">(</span><span class="va">year</span><span class="op">)</span> <span class="co">#custom paste function</span></span>
<span>                                    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">year</span>, <span class="st">"-09-01"</span><span class="op">)</span>, </span>
<span>                                      <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">year</span>,<span class="st">"-09-15"</span><span class="op">)</span>, </span>
<span>                                      <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">year</span>, <span class="st">"-09-30"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co">#pipe to unlist() to make a vector </span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># bull trout hatch model</span></span>
<span><span class="va">bt_hatch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_select.html">model_select</a></span><span class="op">(</span>dev.type <span class="op">=</span> <span class="st">"hatch"</span>,</span>
<span>                         author <span class="op">=</span> <span class="st">"Austin et al. 2017"</span>, </span>
<span>                         species <span class="op">=</span> <span class="st">"bull trout"</span>, </span>
<span>                         model <span class="op">=</span> <span class="st">"MM"</span><span class="op">)</span></span></code></pre></div>
<p>Then we can map it across our nested dataframe.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># see description of the multiple mapping and pipes below</span></span>
<span><span class="va">hatch_res</span> <span class="op">&lt;-</span> <span class="va">isaak_summ_bt</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>dev_period <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">map2</a></span><span class="op">(</span><span class="va">summ_obj</span>, <span class="va">spawn_dates</span>, </span>
<span>                          <span class="va">predict_phenology</span>,</span>
<span>                          temperature <span class="op">=</span> <span class="va">daily_temp</span>,</span>
<span>                          model <span class="op">=</span> <span class="va">bt_hatch</span>,</span>
<span>                          dates <span class="op">=</span> <span class="va">date</span></span>
<span>                          <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>           <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_df</a></span><span class="op">(</span><span class="st">"dev.period"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">site</span>, <span class="va">dev_period</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># just select the columns we want</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">dev_period</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># unnest everything</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>days_to_hatch <span class="op">=</span> <span class="va">stop</span> <span class="op">-</span> <span class="va">start</span><span class="op">)</span> <span class="co"># make a new column of days to hatch</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">hatch_res</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="its-not-output-here-but-this-will-output-a-boatload-of-warnings-that-some-fish-arent-hatching--however-its-pretty-safe-to-assume-that-some-of-these-habitats-are-actually-too-cold-for-bull-trout-and-those-are-the-places-where-they-wont-have-hatched--if-we-were-trying-to-make-management-decisions-about-these-fish-or-testing-a-some-kind-of-hypothesis-it-would-be-worth-following-up-with-why-those-fish-werent-hatching-but-for-now-well-rest-on-the-assumption-its-just-too-cold-">It’s not output here, but this will output a boatload of warnings
that some fish aren’t hatching. However, it’s pretty safe to assume that
some of these habitats are actually too cold for bull trout and those
are the places where they won’t have hatched. If we were trying to make
management decisions about these fish or testing a some kind of
hypothesis it would be worth following up with why those fish weren’t
hatching, but for now, we’ll rest on the assumption it’s just too
cold.<a class="anchor" aria-label="anchor" href="#its-not-output-here-but-this-will-output-a-boatload-of-warnings-that-some-fish-arent-hatching--however-its-pretty-safe-to-assume-that-some-of-these-habitats-are-actually-too-cold-for-bull-trout-and-those-are-the-places-where-they-wont-have-hatched--if-we-were-trying-to-make-management-decisions-about-these-fish-or-testing-a-some-kind-of-hypothesis-it-would-be-worth-following-up-with-why-those-fish-werent-hatching-but-for-now-well-rest-on-the-assumption-its-just-too-cold-"></a>
</h3>
</div>
<p>A couple notes about what we did above. First we use
<code><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">map2()</a></code> instead of <code><a href="https://purrr.tidyverse.org/reference/pmap.html" class="external-link">pmap()</a></code> but they are
interchangeable here as long as you set up your variable grid for
<code><a href="https://purrr.tidyverse.org/reference/pmap.html" class="external-link">pmap()</a></code>. Secondly, we’re actually piping the output of the
<code><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">map2()</a></code> into <code><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_df()</a></code> function so we can just
pull out the <code>dev.period</code> list element out of the
<code><a href="../reference/predict_phenology.html">predict_phenology()</a></code> output. Otherwise we’d end up with a
list of the 4 outputs from <code><a href="../reference/predict_phenology.html">predict_phenology()</a></code>, which would
end up being a pretty big object in your memory. So better just to store
the 1x2 vector that is <code>dev.period</code>. Lastly, the
<code><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_df()</a></code> is piped into a list because the nested dataframe
doesn’t know how to hold onto multiple dimension object (the 1x2
vector), it just wants a singular list containing all the elements.</p>
<p>With that in mind we can plot our data.</p>
<p>Briefly, we’ll add an extra set of columns to define whether a fish
spawned early, mid, or late and then plot the distributions across those
time periods.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">hatch_res</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>day <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html" class="external-link">day</a></span><span class="op">(</span><span class="va">start</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># convert spawn date to day of month</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>spawn_time <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span><span class="va">day</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Early"</span>,</span>
<span>                                <span class="va">day</span> <span class="op">==</span> <span class="fl">15</span> <span class="op">~</span> <span class="st">"Mid"</span>,</span>
<span>                                <span class="va">day</span> <span class="op">==</span> <span class="fl">30</span> <span class="op">~</span> <span class="st">"Late"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># add a character column to match day</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>spawn_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">spawn_time</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Late"</span>, <span class="st">"Mid"</span>, <span class="st">"Early"</span><span class="op">)</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># reorder as factors</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">days_to_hatch</span>, y <span class="op">=</span> <span class="va">spawn_time</span>, fill <span class="op">=</span> <span class="va">spawn_time</span>, color <span class="op">=</span> <span class="va">spawn_time</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="co"># plot!</span></span>
<span>  <span class="fu"><a href="https://wilkelab.org/ggridges/reference/geom_density_ridges.html" class="external-link">geom_density_ridges</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Blues"</span>, direction <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Blues"</span>, direction <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Days to hatch"</span>, y <span class="op">=</span> <span class="st">"Spawn time"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span>  </span></code></pre></div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-isaak2018" class="csl-entry">
Isaak, Daniel J., Charles H. Luce, Gwynne L. Chandler, Dona L. Horan,
and Sherry P. Wollrab. 2018. <span>“Principal Components of Thermal
Regimes in Mountain River Networks.”</span> <em>Hydrology and Earth
System Sciences</em> 22 (12): 6225–40. <a href="https://doi.org/10.5194/hess-22-6225-2018" class="external-link">https://doi.org/10.5194/hess-22-6225-2018</a>.
</div>
<div id="ref-isaak2015" class="csl-entry">
Isaak, Daniel J., Michael K. Young, David E. Nagel, Dona L. Horan, and
Matthew C. Groce. 2015. <span>“The Cold-Water Climate Shield:
Delineating Refugia for Preserving Salmonid Fishes Through the 21st
Century.”</span> <em>Global Change Biology</em> 21 (7): 2540–53. <a href="https://doi.org/10.1111/gcb.12879" class="external-link">https://doi.org/10.1111/gcb.12879</a>.
</div>
</div>
<p>:::::::</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Bryan Maitland, Morgan Sparks.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
